name: Build crDroid 16.0 Kernel - OnePlus 11

on:
  workflow_dispatch: # 手动触发编译

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@main
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y git-core gnupg flex bison build-essential python3 \
            zip curl zlib1g-dev libncurses5-dev libssl-dev bc libelf-dev libxml2-bin \
            tar python3-pip lz4 wget pahole

      - name: Sync Source Code
        run: |
          # 克隆主内核 (Branch 16.0)
          git clone https://github.com/crdroidandroid/android_kernel_oneplus_sm8550.git -b 16.0 kernel-src
          cd kernel-src
          
          # 克隆模块仓库到正确位置
          git clone https://github.com/crdroidandroid/android_kernel_oneplus_sm8550-modules.git -b 16.0 modules
          
          # 克隆设备树仓库
          git clone https://github.com/crdroidandroid/android_kernel_oneplus_sm8550-devicetrees.git -b 16.0 devicetree

      - name: Setup KernelSU Next
        run: |
          cd kernel-src
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s next
          # 注入配置到 defconfig
          echo "CONFIG_KSU=y" >> arch/arm64/configs/vendor/kalama_GKI.config
          echo "CONFIG_OVERLAY_FS=y" >> arch/arm64/configs/vendor/kalama_GKI.config

      - name: Download Clang Toolchain
        run: |
          mkdir clang
          # 使用 AOSP 官方 Clang r522815
          wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r522815.tar.gz
          tar -C clang -xf clang-r522815.tar.gz

      - name: Build Kernel
        run: |
          cd kernel-src
          export PATH=$GITHUB_WORKSPACE/clang/bin:$PATH
          
          # 编译命令
          make O=out ARCH=arm64 LLVM=1 LLVM_IAS=1 \
               CROSS_COMPILE=aarch64-linux-gnu- \
               CROSS_COMPILE_COMPAT=arm-linux-gnueabi- \
               vendor/kalama_GKI.config
          
          make -j$(nproc) O=out ARCH=arm64 LLVM=1 LLVM_IAS=1 \
               CROSS_COMPILE=aarch64-linux-gnu- \
               CROSS_COMPILE_COMPAT=arm-linux-gnueabi- \
               NM=llvm-nm OBJCOPY=llvm-objcopy LD=ld.lld

      - name: Package AnyKernel3
        run: |
          git clone https://github.com/osm0sis/AnyKernel3.git
          cp kernel-src/out/arch/arm64/boot/Image AnyKernel3/
          cd AnyKernel3
          # 修改适配一加11
          sed -i 's/device.name1=maguro/device.name1=salami/g' anykernel.sh
          zip -r9 ../OnePlus11-crDroid16-KSU.zip *

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-KSU-OnePlus11
          path: OnePlus11-crDroid16-KSU.zip