name: Build crDroid OnePlus 11 Kernel

on:
  workflow_dispatch:
    inputs:
      FEIL:
        description: 'æ„å»ºäº§ç‰©åç§°'
        default: 'Salami'
      lz4kd:
        description: 'å¯ç”¨ lz4kd'
        default: 'true'
      proxy:
        description: 'å¼€å¯ä»£ç†ä¼˜åŒ– (On/Off)'
        default: 'On'
      KERNEL_VERSION:
        description: 'å†…æ ¸ç‰ˆæœ¬'
        default: '5.15'

jobs:
  build:
    name: For ${{ github.event.inputs.FEIL }} lz4kd ${{ github.event.inputs.lz4kd }}
    runs-on: ubuntu-latest
    env:
      CLANG_VERSION: clang-r547379
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_MAXSIZE: 8G

    steps:
    - name: "ğŸš€ Maximize Build Space"
      if: ${{ github.event.inputs.KERNEL_VERSION == '5.10' || github.event.inputs.KERNEL_VERSION == '5.15' }}
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 8192
        temp-reserve-mb: 4096
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git bc bison flex libssl-dev make zip ccache libelf-dev dwarves

    - name: Cache Clang
      id: cache-clang
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/clang-aosp
        key: ${{ env.CLANG_VERSION }}

    - name: Download Clang
      if: steps.cache-clang.outputs.cache-hit != 'true'
      run: |
        mkdir -p clang-aosp
        wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/${{ env.CLANG_VERSION }}.tar.gz
        tar -C clang-aosp -zxvf ${{ env.CLANG_VERSION }}.tar.gz

    - name: Clone Sources
      run: |
        git clone --recursive --depth=1 https://github.com/crdroidandroid/android_kernel_oneplus_sm8550 -b 16.0 sm8550
        git clone --recursive --depth=1 https://github.com/crdroidandroid/android_kernel_oneplus_sm8550-modules -b 16.0 sm8550-modules

    - name: Compile
      run: |
        cd sm8550
        
        # é›†æˆ KernelSU
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
        
        # å®šä¹‰é…ç½®æ–‡ä»¶è·¯å¾„
        DEFCONFIG=arch/arm64/configs/gki_defconfig
        
        # 1. åŠ å…¥ä»£ç†ä¼˜åŒ–é…ç½®
        if [ "${{ github.event.inputs.proxy }}" == "On" ]; then
          echo "ğŸ“¦ åŠ å…¥ä»£ç†ä¼˜åŒ–..."
          echo "CONFIG_BPF_STREAM_PARSER=y" >> $DEFCONFIG
          echo "CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y" >> $DEFCONFIG
          echo "CONFIG_NETFILTER_XT_SET=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_MAX=65534" >> $DEFCONFIG
          echo "CONFIG_IP_SET_BITMAP_IP=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_BITMAP_IPMAC=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_BITMAP_PORT=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_IP=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_IPMARK=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_IPPORT=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_IPPORTIP=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_IPPORTNET=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_IPMAC=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_MAC=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_NETPORTNET=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_NET=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_NETNET=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_NETPORT=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_HASH_NETIFACE=y" >> $DEFCONFIG
          echo "CONFIG_IP_SET_LIST_SET=y" >> $DEFCONFIG
          echo "CONFIG_IP6_NF_NAT=y" >> $DEFCONFIG
          echo "CONFIG_IP6_NF_TARGET_MASQUERADE=y" >> $DEFCONFIG
        fi

        # 2. é’ˆå¯¹ 5.10/5.15 ç³»é…ç½® ThinLTO
        if [ "${{ github.event.inputs.KERNEL_VERSION }}" = "5.10" ] || [ "${{ github.event.inputs.KERNEL_VERSION }}" = "5.15" ]; then
          echo "ğŸ“¦ æ­£åœ¨ä¸º5.10ç³»ä¸5.15ç³»é…ç½®ltoä¸­..."
          sed -i 's/^CONFIG_LTO=n/CONFIG_LTO=y/' "$DEFCONFIG"
          sed -i 's/^CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_CLANG_THIN=y/' "$DEFCONFIG"
          sed -i 's/^CONFIG_LTO_CLANG_NONE=y/CONFIG_LTO_CLANG_THIN=y/' "$DEFCONFIG"
          grep -q '^CONFIG_LTO_CLANG_THIN=y' "$DEFCONFIG" || echo 'CONFIG_LTO_CLANG_THIN=y' >> "$DEFCONFIG"
        fi

        # 3. ä¿®å¤ BTF æŠ¥é”™
        sed -i 's/CONFIG_DEBUG_INFO_BTF=y/CONFIG_DEBUG_INFO_BTF=n/' $DEFCONFIG

        # ç¯å¢ƒå˜é‡ä¸ç¼–è¯‘å‚æ•°
        export PATH=${{ github.workspace }}/clang-aosp/bin:$PATH
        MAKE_ARGS="ARCH=arm64 LLVM=1 LLVM_IAS=1 CC=clang CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_COMPAT=arm-linux-gnueabi- O=out"
        
        # æŒ‰ç…§è¦æ±‚åˆå¹¶é…ç½®å¹¶å¯åŠ¨ç¼–è¯‘
        make $MAKE_ARGS gki_defconfig vendor/kalama_GKI.config vendor/oplus/kalama_GKI.config
        make -j$(nproc --all) $MAKE_ARGS

    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.event.inputs.FEIL }}-Kernel
        path: sm8550/out/arch/arm64/boot/Image